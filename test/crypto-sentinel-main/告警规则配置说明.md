# 🚨 告警规则配置说明

## ✅ 已实现的功能

### 1. **价格变化告警**
- **规则**：持仓代币在 5 分钟内涨跌超过 5%
- **级别**：关键告警（critical）
- **静音时段**：凌晨 2:00-6:00（北京时间）
- **冷却时间**：15 分钟（避免重复告警同一个币种）
- **响铃方式**：连续发送 5 次，模拟持续 5 秒响铃

### 2. **保证金率告警**
- **规则**：保证金率低于或等于 20%
- **级别**：关键告警（critical）
- **静音时段**：凌晨 2:00-5:00（北京时间）
- **冷却时间**：10 分钟
- **响铃方式**：连续发送 5 次

### 3. **关键提醒功能**
- 使用 Bark 的 `level=critical` 参数
- 使用 `alarm` 声音（较长且紧急）
- 自动保存到历史记录（`isArchive=1`）
- 连续发送 5 次通知，每次间隔 1 秒

## 📋 配置文件位置

所有告警规则配置在：
```
apps/backend/src/config/alert-rules.config.ts
```

## 🎯 规则配置示例

```typescript
{
  id: 'price-change-5min-5pct',
  name: '价格剧烈波动告警',
  description: '持仓代币5分钟内价格涨跌超过5%',
  type: 'priceChange',
  enabled: true,
  level: 'critical',
  threshold: 5,             // 5%
  timeWindow: 5,            // 5分钟
  cooldown: 15,             // 15分钟冷却
  quietHours: {
    start: 2,               // 凌晨2点
    end: 6,                 // 早上6点
    timezone: 'Asia/Shanghai',
  },
}
```

## 🔧 如何添加新规则

### 步骤1：编辑配置文件
打开 `apps/backend/src/config/alert-rules.config.ts`，在 `DEFAULT_ALERT_RULES` 数组中添加新规则。

### 步骤2：支持的规则类型

#### 价格变化规则（priceChange）
```typescript
{
  type: 'priceChange',
  threshold: 10,      // 涨跌幅百分比
  timeWindow: 10,     // 时间窗口（分钟）
  cooldown: 20,       // 冷却时间（分钟）
}
```

#### 保证金率规则（marginRatio）
```typescript
{
  type: 'marginRatio',
  threshold: 15,      // 保证金率百分比
  operator: 'lte',    // 小于等于
  cooldown: 10,
}
```

#### 持仓规模规则（positionSize）
```typescript
{
  type: 'positionSize',
  threshold: 5000,    // 持仓价值（USDT）
  operator: 'gte',    // 大于等于
  cooldown: 30,
}
```

#### 盈亏规则（pnl）
```typescript
{
  type: 'pnl',
  threshold: -500,    // 盈亏金额（USDT）
  operator: 'lte',    // 小于等于
  cooldown: 20,
}
```

### 步骤3：告警级别

- **critical**：关键告警，连续响铃5次，可突破静音
- **timeSensitive**：时间敏感，高优先级但不突破静音
- **normal**：普通通知

### 步骤4：运算符

- **lt**：小于 (less than)
- **lte**：小于等于 (less than or equal)
- **gt**：大于 (greater than)
- **gte**：大于等于 (greater than or equal)

## 📱 测试关键告警

### 方法1：使用测试接口
```bash
curl -X POST http://localhost:3000/api/alert/test-critical \
  -H "Content-Type: application/json" \
  -d '{"message":"测试静音下的强制响铃"}'
```

### 方法2：等待实际触发
- 价格变化：等待持仓代币5分钟内涨跌超过5%
- 保证金率：当保证金率降到20%以下时自动触发

## ⚙️ 系统运行原理

### 价格监控流程
1. FuturesMonitorService 每10秒检查一次持仓
2. 记录每个币种的价格历史（保留10分钟）
3. AlertManager 检查是否满足告警规则
4. 如果满足且不在静默时段，触发告警
5. 设置冷却时间，避免重复告警

### 保证金率监控
1. 每1分钟检查一次账户保证金率
2. 与配置的阈值比较
3. 满足条件且不在静默时段时触发告警
4. 设置冷却时间

### 静默时段检查
- 自动转换为北京时间（Asia/Shanghai）
- 支持跨天配置（如22:00-02:00）
- 在静默时段内的告警会被跳过

## 🔍 查看运行状态

### 后端日志
```bash
# 查看实时日志
tail -f logs/backend.log

# 查找告警相关日志
grep "🚨\|⚠️\|🔔" logs/backend.log
```

### 关键日志标记
- `🚨 发送关键告警` - 关键告警已发送
- `⚠️ 发送时间敏感通知` - 时间敏感通知
- `🔔 告警触发` - 告警被触发
- `📊 Position Summary` - 持仓摘要
- `⚠️ markPrice is 0` - 价格数据异常

## 📊 配置示例

### 示例1：10分钟涨跌10%告警
```typescript
{
  id: 'price-change-10min-10pct',
  name: '价格巨幅波动告警',
  type: 'priceChange',
  enabled: true,
  level: 'critical',
  threshold: 10,
  timeWindow: 10,
  cooldown: 20,
  quietHours: { start: 2, end: 6, timezone: 'Asia/Shanghai' },
}
```

### 示例2：保证金率低于15%
```typescript
{
  id: 'margin-ratio-critical',
  name: '保证金率危险告警',
  type: 'marginRatio',
  enabled: true,
  level: 'critical',
  threshold: 15,
  operator: 'lte',
  cooldown: 5,
  quietHours: { start: 2, end: 6, timezone: 'Asia/Shanghai' },
}
```

### 示例3：亏损超过1000U
```typescript
{
  id: 'pnl-loss-1000',
  name: '大额亏损告警',
  type: 'pnl',
  enabled: true,
  level: 'timeSensitive',
  threshold: -1000,
  operator: 'lte',
  cooldown: 30,
  quietHours: { start: 2, end: 6, timezone: 'Asia/Shanghai' },
}
```

## ⚠️ 注意事项

1. **关键提醒权限**：
   - 打开 iPhone 设置 > 通知 > Bark
   - 确保开启"关键提醒"选项
   - 如果没有此选项，说明 Bark 版本不支持

2. **静默时段**：
   - 默认北京时间凌晨 2:00-6:00 不发送告警
   - 保证金率告警的静默时段是 2:00-5:00
   - 可根据需要调整

3. **冷却时间**：
   - 防止同一条件反复触发
   - 价格告警每个币种独立冷却
   - 保证金率全局冷却

4. **性能影响**：
   - 价格检查每10秒一次
   - 保证金率检查每1分钟一次
   - 对服务器负载影响很小

## 🎓 常见问题

### Q1: 为什么没收到告警？
1. 检查规则是否启用（`enabled: true`）
2. 检查是否在静默时段
3. 检查是否在冷却期内
4. 查看后端日志确认规则是否触发

### Q2: 如何调整响铃时长？
修改 `sendCriticalAlert` 的 `repeat` 参数：
```typescript
await this.barkService.sendCriticalAlert(title, body, 5); // 5次
```

### Q3: 如何禁用某个规则？
在配置文件中设置 `enabled: false`：
```typescript
{
  id: 'price-change-5min-5pct',
  enabled: false,  // 禁用此规则
  // ...
}
```

### Q4: 能否添加自定义时区？
可以，修改 `timezone` 字段：
```typescript
quietHours: {
  start: 22,
  end: 6,
  timezone: 'America/New_York',  // 纽约时间
}
```

## 🔄 重启服务

修改配置后需要重启后端：
```bash
cd /Users/qiuzhiyang/Desktop/bn/crypto-sentinel
./stop-all.sh
./start-backend.sh
```

或者只重启后端：
```bash
cd apps/backend
pnpm run start:dev
```

## 📝 更新日志

- **2025-10-14**：初始版本
  - 实现价格变化告警（5分钟5%）
  - 实现保证金率告警（≤20%）
  - 支持静默时段（凌晨2-6点）
  - 支持关键提醒（critical level）
  - 支持冷却时间机制

